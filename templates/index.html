<!doctype html>
<html lang="en">
  <head>
    <script src="https://code.jquery.com/jquery.min.js"></script>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.8.2/css/ol.css" type="text/css">
    <style>
      .map {
        height: 400px;
        width: 100%;
      }
    </style>
    <script src="http://openlayers.org/en/v3.8.2/build/ol.js" type="text/javascript"></script>
    <title>OpenLayers 3 example</title>
  </head>
  <body>
    <h2>Realtime Earth</h2>
    <div id="map" class="map"></div>
    <script type="text/javascript">
      var transform = ol.proj.getTransform('EPSG:3857', 'EPSG:4326');

      var map = new ol.Map({
        controls: [],
        interactions : ol.interaction.defaults({
          doubleClickZoom: false,
          dragZoom: false,
          keyboardZoom: false,
          mouseWheelZoom: false,
          pinchZoom: false,
        }),
        target: 'map',
        renderer: 'canvas', // Force the renderer to be used
        layers: [
          new ol.layer.Tile({
            source: new ol.source.MapQuest({layer: 'sat'})
          })
        ],
        view: new ol.View({
          center: ol.proj.transform([-122.3020636,37.8732388], 'EPSG:4326', 'EPSG:3857'),
          zoom: 18
        })
      });

      // Create an image layer
      var imageLayer = new ol.layer.Image({
        opacity: 0.75,
        source: new ol.source.ImageStatic({
          attributions: [
            new ol.Attribution({
              html: '&copy; <a href="https://www.lib.utexas.edu/maps/historical/">University of Texas Libraries</a>'
            })
          ],
          url: 'https://www.lib.utexas.edu/maps/historical/newark_nj_1922.jpg',
          imageSize: [691, 541],
          projection: map.getView().getProjection(),
          imageExtent: ol.extent.applyTransform([-122.3020636, 37.8732388, -122.3020636 - 0.001, 37.8732388 - 0.001], ol.proj.getTransform("EPSG:4326", "EPSG:3857"))
        })
      });

      map.addLayer(imageLayer);

      var iconFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.transform([-122.3020636, 37.8732388], 'EPSG:4326',     
  'EPSG:3857')),
        name: 'Solo',
      });

      iconFeature.setStyle(new ol.style.Style({
        image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
          anchor: [0.5, 46],
          anchorXUnits: 'fraction',
          anchorYUnits: 'pixels',
          opacity: 1,
          src: 'static/images/solo.png',
          scale: .15,
        }))
      }));

      var vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector({
          features: [ iconFeature ]
        }),
      });

      map.addLayer(vectorLayer)

      map.on('dblclick', function(evt) {
        var coord = transform(evt.coordinate);
        $.ajax({
          method: 'PUT',
          url: '/api/location',
          contentType : 'application/json',
          data: JSON.stringify({ lat: coord[1], lon: coord[0] }),
        })
        .done(function( msg ) {
          console.log('sent data')
        });
      });

      var source = new EventSource('/api/sse/location');
      source.onmessage = function (event) {
        var msg = JSON.parse(event.data);
        console.log(msg);
        iconFeature.setGeometry(new ol.geom.Point(ol.proj.transform([msg.lon, msg.lat], 'EPSG:4326',     
  'EPSG:3857')));
      };
    </script>
  </body>
</html>
